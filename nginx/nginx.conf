worker_processes 1;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  log_format access_json escape=json
  '{'
    '"ts":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"method":"$request_method",'
    '"path":"$uri",'
    '"request_uri":"$request_uri",'
    '"status":$status,'
    '"referer":"$http_referer",'
    '"request_id":"$request_id",'
    '"bytes_sent":$bytes_sent,'
    '"user_id":"$http_x_user_id",'
    '"request_time":$request_time,'
    '"user_agent":"$http_user_agent",'
    '"session_id":"$cookie_session_id"'
  '}';

  access_log /var/log/nginx_files/access.jsonl access_json;

  server {
    listen 80;

    location = /healthz { return 200 "ok\n"; }
    location = /favicon.ico { return 200 "ok\n"; }
    location = /robots.txt  { return 200 "User-agent: *\nDisallow:\n"; }
    location = /sitemap.xml { return 200 "<xml>ok</xml>\n"; }
    location = /        { return 200 "home\n"; }
    location = /products { return 200 "products\n"; }
    location = /cart     { return 200 "cart\n"; }
    location = /checkout { return 200 "checkout\n"; }
    location = /login    { return 200 "login\n"; }
    location = /logout   { return 200 "logout\n"; }

    location ^~ /product/ { return 200 "product\n"; }

    location = /search { return 200 "search\n"; }

    location ^~ /api/ {
      return 200 "api\n";
    }

    location = /api/missing { return 404 "not found\n"; }
    location = /api/rate_limited { return 429 "too many requests\n"; }
    location = /admin { return 403 "forbidden\n"; }

    location = /admin/login {
      add_header WWW-Authenticate 'Basic realm="Restricted"' always;
      return 401 "unauthorized\n";
    }

    location = /internal/metrics { return 403 "forbidden\n"; }
    location = /.env       { return 404 "not found\n"; }
    location = /.git/config { return 404 "not found\n"; }
    location = /wp-login.php { return 404 "not found\n"; }
    location = /phpmyadmin   { return 404 "not found\n"; }
    location / { return 404 "not found\n"; }
  }
}
